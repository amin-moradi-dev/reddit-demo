<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">Post Details</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>
<body>

<!-- Header fragment -->
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4" style="max-width: 800px;">

<a href="/" class="btn btn-warning mb-3">← Back to Home</a>

    <!-- Post -->
    <h1 th:text="${post.title}">Post Title</h1>
    <p class="text-muted">
        Posted by <strong th:text="${post.author.username}">Author</strong>
        in <strong th:text="${post.community?.name} ?: 'No Community'">Community</strong>
        on <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">Date</span>
    </p>

    <div th:if="${post.imageUrl}">
        <img th:src="${post.imageUrl}" alt="Post Image" class="img-fluid mb-3">
    </div>

    <p th:text="${post.content}">Post content here...</p>

    <hr>

    <!-- Comment Form -->
    <div th:if="${username != 'guest'}" class="mb-4">
        <h5>Add a Comment:</h5>
        <!-- ✅ Use id="comment-form" for JS -->
        <form id="comment-form" th:object="${newComment}">
            <div class="mb-3">
                <textarea th:field="*{content}" class="form-control" rows="3" placeholder="Write your comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-warning">Post Comment</button>
        </form>
    </div>

    <!-- Guest Prompt -->
    <div th:if="${username == 'guest'}" class="mb-4">
        <p><a href="/login">Login</a> or <a href="/register">Register</a> to post a comment.</p>
    </div>

    <hr>

    <!-- Comments Section -->
    <h5 th:text="'Comments (' + ${#lists.size(comments)} + ')'">Comments</h5>
    <div id="comments-section">
        <div th:if="${#lists.isEmpty(comments)}">
            <p>No comments yet. Be the first to comment!</p>
        </div>
        <div th:each="comment : ${comments}" class="mb-3 border-bottom pb-2 d-flex align-items-start">
            <!-- ✅ User profile image -->
            <img th:src="${comment.author.profileImageUrl}" alt="Profile" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">

            <div>
                <p class="mb-1">
                    <strong th:text="${comment.author.username}">Username</strong>
                    <span class="text-muted" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">Date</span>
                </p>
                <p th:text="${comment.content}">Comment content</p>
            </div>
        </div>
    </div>


</div>

<!-- Footer fragment -->
<div th:replace="fragments/footer :: footer"></div>

<!-- ✅ AJAX script to submit comment without reloading -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const commentForm = document.getElementById('comment-form');
    if(commentForm){
        commentForm.addEventListener('submit', function(e){
            e.preventDefault();

            const postId = /*[[${post.id}]]*/ 0;
            const content = commentForm.querySelector('textarea').value;

            fetch('/posts/' + postId + '/comments/ajax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': /*[[${_csrf.token}]]*/ ''
                },
                body: JSON.stringify({content: content})
            })
                .then(resp => {
                    if(resp.ok) return resp.json();
                    throw new Error('Network error');
                })
                .then(data => {
                    // Clear textarea
                    commentForm.querySelector('textarea').value = '';

                    // Append new comment with profile image
                    const commentsSection = document.getElementById('comments-section');
                    const div = document.createElement('div');
                    div.classList.add('mb-3','border-bottom','pb-2','d-flex','align-items-start');
                    div.innerHTML = `
                        <img src="${data.profileImageUrl || '/images/p-1.jpg'}" alt="Profile" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                        <div>
                            <p class="mb-1">
                                <strong>${data.author}</strong>
                                <span class="text-muted">${data.createdAt}</span>
                            </p>
                            <p>${data.content}</p>
                        </div>
                    `;
                    commentsSection.prepend(div);
                })
                .catch(err => console.error(err));
        });
    }
    /*]]>*/
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
