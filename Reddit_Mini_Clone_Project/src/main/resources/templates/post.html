<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout :: layout">
<body>
<div th:fragment="body" class="col-md-8 offset-md-2">
    <h3 th:text="${post.title}"></h3>
    <div class="text-muted mb-2">
        <span th:text="'by ' + ${post.author.fullName}"></span>
    </div>

    <div th:utext="${post.contentHtml}" class="border rounded p-3 mb-3"></div>

    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-sm btn-outline-success me-2" id="upvoteBtn">▲</button>
        <span id="voteCount" class="mx-1" th:text="${upvotes - downvotes}"></span>
        <button class="btn btn-sm btn-outline-danger ms-2" id="downvoteBtn">▼</button>
    </div>

    <h5>Comments</h5>
    <form th:action="@{'/comment/' + ${post.id} + '/reply'}" method="post" class="mb-3">
        <textarea name="body" class="form-control mb-2" rows="2" placeholder="Add a comment..."></textarea>
        <button class="btn btn-primary btn-sm">Post Comment</button>
    </form>

    <div th:each="c : ${post.comments}" class="border-top pt-2">
        <p th:text="${c.body}"></p>
        <small class="text-muted" th:text="${c.user.fullName}"></small>
    </div>
</div>

<script>
    document.getElementById("upvoteBtn")?.addEventListener("click", () => vote(1));
    document.getElementById("downvoteBtn")?.addEventListener("click", () => vote(-1));

    function vote(value) {
        const postId = [[${post.id}]];
        fetch(`/api/post/${postId}/${value === 1 ? 'upvote' : 'downvote'}`, {method:'POST'})
            .then(r => r.json())
            .then(d => document.getElementById("voteCount").innerText = d.upvotes - d.downvotes);
    }
</script>
</body>
</html>
